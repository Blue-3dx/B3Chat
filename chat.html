<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chatroom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; margin: 0; }
    #container { display: flex; max-width: 1000px; margin: auto; }
    #leftPanel, #rightPanel { padding: 10px; }
    #leftPanel { flex: 3; }
    #rightPanel { flex: 1; background: #fff; border-left: 1px solid #ccc; }

    #messages { height: 300px; overflow-y: auto; background: white; padding: 10px; border: 1px solid #ccc; margin-bottom: 10px; }
    .message { margin-bottom: 6px; }
    .host { font-weight: bold; color: #d9534f; }

    #usersList div { cursor: pointer; padding: 4px; }
    #usersList div:hover { background: #eee; }

    .profile-popup {
      position: fixed;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      width: 180px;
      z-index: 1000;
      display: none;
    }

    .badge {
      width: 16px; height: 16px;
      vertical-align: middle;
      margin-right: 5px;
    }

    #consoleBtn, #settingsBtn {
      position: fixed;
      bottom: 10px;
      padding: 8px;
    }

    #consoleBtn { right: 10px; }
    #settingsBtn { right: 100px; }
  </style>
</head>
<body>

<h2>Welcome, <span id="currentUsername"></span></h2>

<div id="container">
  <div id="leftPanel">
    <input type="text" id="newRoomName" placeholder="New Chatroom Name" />
    <button id="createRoomBtn">Create Room</button>
    <button id="searchRoomsBtn">Search Rooms</button>

    <div id="chatroom-list">
      <h3>Available Chatrooms</h3>
      <ul id="roomsUl"></ul>
    </div>

    <div id="chatroom" style="display:none;">
      <h3>Chatroom: <span id="roomTitle"></span> <span id="roomStatus" style="font-size:small;"></span></h3>
      <div id="messages"></div>
      <input type="text" id="messageInput" placeholder="Type message..." />
      <button id="sendMessageBtn">Send</button>
      <button id="leaveRoomBtn" style="background:#dc3545; color:white;">Leave</button>
    </div>
  </div>

  <div id="rightPanel">
    <h4>Users in Room</h4>
    <div id="usersList"></div>
  </div>
</div>

<div id="profilePopup" class="profile-popup"></div>
<button id="consoleBtn" style="display:none;">Console</button>
<button id="settingsBtn">Settings</button>

<script>
(() => {
  let ws;
  let username = null;
  let currentRoom = null;
  let isHost = false;
  const params = new URLSearchParams(window.location.search);
  username = params.get('username');
  if (!username) return location.href = '/';

  const currentUsernameSpan = document.getElementById('currentUsername');
  const newRoomNameInput = document.getElementById('newRoomName');
  const createRoomBtn = document.getElementById('createRoomBtn');
  const searchRoomsBtn = document.getElementById('searchRoomsBtn');
  const roomsUl = document.getElementById('roomsUl');
  const chatroomDiv = document.getElementById('chatroom');
  const roomTitleSpan = document.getElementById('roomTitle');
  const roomStatusSpan = document.getElementById('roomStatus');
  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendMessageBtn = document.getElementById('sendMessageBtn');
  const leaveRoomBtn = document.getElementById('leaveRoomBtn');
  const usersList = document.getElementById('usersList');
  const profilePopup = document.getElementById('profilePopup');
  const consoleBtn = document.getElementById('consoleBtn');
  const settingsBtn = document.getElementById('settingsBtn');

  currentUsernameSpan.textContent = username;
  if (username === 'Blue_3dx') consoleBtn.style.display = 'block';

  function connectWebSocket() {
    ws = new WebSocket(window.location.origin.replace(/^http/, 'ws'));
    ws.onopen = () => ws.send(JSON.stringify({ type: 'set_username', username }));
    ws.onmessage = (event) => {
      let data = JSON.parse(event.data);
      handleServerMessage(data);
    };
    ws.onclose = () => {
      alert('Disconnected from server.');
      window.location.href = '/';
    };
    ws.onerror = err => console.error('WebSocket error', err);
  }

  function handleServerMessage(data) {
    switch (data.type) {
      case 'room_list': displayRoomList(data.rooms); break;
      case 'joined_room': enterRoom(data.roomName, data.isHost); break;
      case 'message': addMessage(data.user, data.text, data.isHost); break;
      case 'room_status': setRoomStatus(data.isPrivate); break;
      case 'users_in_room': updateUserList(data.users); break;
      case 'error': alert('Error: ' + data.message); break;
    }
  }

  function displayRoomList(rooms) {
    roomsUl.innerHTML = '';
    if (rooms.length === 0) {
      roomsUl.innerHTML = '<li>No rooms available</li>';
      return;
    }
    rooms.forEach(room => {
      const li = document.createElement('li');
      li.textContent = `${room.name} (${room.userCount})`;
      li.onclick = () => joinRoom(room.name);
      roomsUl.appendChild(li);
    });
  }

  function enterRoom(roomName, host) {
    currentRoom = roomName;
    isHost = host;
    roomTitleSpan.textContent = roomName;
    chatroomDiv.style.display = 'block';
    document.getElementById('chatroom-list').style.display = 'none';
    newRoomNameInput.disabled = true;
    createRoomBtn.disabled = true;
    searchRoomsBtn.disabled = true;
  }

  function setRoomStatus(isPrivate) {
    roomStatusSpan.textContent = isPrivate ? '(Private)' : '(Public)';
  }

  function addMessage(user, text, isHostMsg) {
    const div = document.createElement('div');
    div.className = 'message';
    div.innerHTML = user === 'System'
      ? `<i>* ${text}</i>`
      : `<span${isHostMsg ? ' class="host"' : ''}>${user}</span>: ${escapeHtml(text)}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function updateUserList(usernames) {
    usersList.innerHTML = '';
    usernames.forEach(name => {
      const div = document.createElement('div');
      div.textContent = name;
      div.onclick = () => showProfile(name);
      usersList.appendChild(div);
    });
  }

  function showProfile(user) {
    const isStaff = user === 'Blue_3dx';
    profilePopup.innerHTML = `
      <strong>${user}</strong><br/>
      ${isStaff ? '<img class="badge" src="https://raw.githubusercontent.com/B3Chat/data/main/Staff.png" title="Staff Badge">' : ''}
    `;
    profilePopup.style.display = 'block';
    profilePopup.style.left = event.pageX + 'px';
    profilePopup.style.top = event.pageY + 'px';
    setTimeout(() => {
      document.addEventListener('click', hideProfilePopup, { once: true });
    }, 10);
  }

  function hideProfilePopup() {
    profilePopup.style.display = 'none';
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  createRoomBtn.onclick = () => {
    const roomName = newRoomNameInput.value.trim();
    if (roomName) {
      ws.send(JSON.stringify({ type: 'create_room', roomName }));
    }
  };

  searchRoomsBtn.onclick = () => {
    ws.send(JSON.stringify({ type: 'list_rooms' }));
  };

  sendMessageBtn.onclick = () => sendMessage();
  messageInput.onkeydown = e => e.key === 'Enter' && sendMessage();
  function sendMessage() {
    const text = messageInput.value.trim();
    if (text && currentRoom) {
      ws.send(JSON.stringify({ type: 'chat_message', roomName: currentRoom, text }));
      messageInput.value = '';
    }
  }

  leaveRoomBtn.onclick = () => {
    ws.send(JSON.stringify({ type: 'leave_room', roomName: currentRoom }));
    leaveRoomUI();
  };

  function leaveRoomUI() {
    currentRoom = null;
    chatroomDiv.style.display = 'none';
    document.getElementById('chatroom-list').style.display = 'block';
    newRoomNameInput.disabled = false;
    createRoomBtn.disabled = false;
    searchRoomsBtn.disabled = false;
    messagesDiv.innerHTML = '';
  }

  consoleBtn.onclick = () => {
    window.location.href = '/console.html?username=' + encodeURIComponent(username);
  };

  settingsBtn.onclick = () => {
    window.location.href = '/settings.html?username=' + encodeURIComponent(username);
  };

  connectWebSocket();
})();
</script>

</body>
</html>
